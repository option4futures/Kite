#!/usr/bin/env python3
# FULLY AUTOMATED Zerodha + Google Sheets Option Chain (SENSEX, NIFTY, BANKNIFTY)
# Zero manual work | Auto TOTP | Auto login | Runs forever on GitHub Actions

import os
import sys
import json
import time
import pyotp
import pytz
from datetime import datetime

from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By

import gspread
from google.oauth2.service_account import Credentials
from kiteconnect import KiteConnect
from gspread.exceptions import WorksheetNotFound

# ====================== CONFIG & SECRETS ======================
API_KEY             = os.getenv("API_KEY")
API_SECRET          = os.getenv("API_SECRET")
USER_ID             = os.getenv("ZERODHA_USER_ID")
PASSWORD            = os.getenv("ZERODHA_PASSWORD")
TOTP_SECRET         = os.getenv("ZERODHA_TOTP_SECRET")  # Your 2FA seed (never changes)
SHEET_ID            = os.getenv("SHEET_ID")
GOOGLE_CREDS_JSON   = os.getenv("GOOGLE_CREDENTIALS")

# Which indices to update
INDICES = [
    ("SENSEX",   "BFO",   ["2025-11-20"],   "SENSEX_Nov20"),
    ("BANKNIFTY","NFO",   ["2025-11-19"],   "BANKNIFTY_Nov19"),
    ("NIFTY",    "NFO",   ["2025-11-20"],   "NIFTY_Nov20"),
]

# ====================== AUTO TOTP ======================
def get_totp():
    totp = pyotp.TOTP(TOTP_SECRET.replace(" ", ""))
    code = totp.now()
    print(f"Generated TOTP: {code}")
    return code

# ====================== AUTO LOGIN ======================
def zerodha_auto_login():
    print("Starting Zerodha auto-login...")
    kite = KiteConnect(api_key=API_KEY)

    options = Options()
    options.add_argument("--headless")
    options.add_argument("--no-sandbox")
    options.add_argument("--disable-dev-shm-usage")
    options.add_argument("--disable-gpu")
    driver = webdriver.Chrome(options=options)

    try:
        driver.get(kite.login_url())
        time.sleep(4)

        driver.find_element(By.ID, "userid").send_keys(USER_ID)
        driver.find_element(By.ID, "password").send_keys(PASSWORD)
        driver.find_element(By.CSS_SELECTOR, "button[type=submit]").click()
        time.sleep(3)

        driver.find_element(By.ID, "totp").send_keys(get_totp())
        driver.find_element(By.CSS_SELECTOR, "button[type=submit]").click()
        time.sleep(6)

        url = driver.current_url
        request_token = url.split("request_token=")[1].split("&")[0]
        print("Got request_token")

        session = kite.generate_session(request_token, api_secret=API_SECRET)
        kite.set_access_token(session["access_token"])
        print("Fresh access_token generated & set!")
        return kite

    finally:
        driver.quit()

# ====================== GOOGLE SHEETS ======================
def get_sheet():
    creds = Credentials.from_service_account_info(
        json.loads(GOOGLE_CREDS_JSON),
        scopes=["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    )
    gc = gspread.authorize(creds)
    sh = gc.open_by_key(SHEET_ID)
    print("Google Sheets connected")
    return sh

# ====================== MAIN ======================
ist = pytz.timezone("Asia/Kolkata")
now = datetime.now(ist)
print(f"\nRun started: {now.strftime('%Y-%m-%d %H:%M:%S')} IST")

# Market hours check
if now.weekday() >= 5 or now.time() < datetime.strptime("09:10", "%H:%M").time():
    print("Outside market hours. Exiting.")
    sys.exit(0)

# Auto login
kite = zerodha_auto_login()
sh = get_sheet()

for name, exchange, expiries, tab_name in INDICES:
    for expiry in expiries:
        print(f"\nUpdating {name} {expiry} → {tab_name}")

        try:
            try:
                ws = sh.worksheet(tab_name)
            except WorksheetNotFound:
                ws = sh.add_worksheet(title=tab_name, rows=1000, cols=20)

            # Previous OI
            prev_oi = {}
            data = ws.get_all_values()
            if len(data) > 1:
                headers = data[0]
                try:
                    strike_idx = headers.index("Strike")
                    call_oi_idx = headers.index("Call OI")
                    put_oi_idx = headers.index("Put OI")
                    for row in data[1:]:
                        if len(row) > max(strike_idx, call_oi_idx, put_oi_idx):
                            try:
                                s = float(row[strike_idx])
                                prev_oi[s] = {"C": int(row[call_oi_idx] or 0), "P": int(row[put_oi_idx] or 0)}
                            except: pass
                except: pass

            # Fetch instruments & quotes
            instruments = kite.instruments(exchange)
            opts = [i for i in instruments if i["name"] == name and i["expiry"] == expiry]
            tokens = [str(i["instrument_token"]) for i in opts]
            quotes = kite.quote(tokens)

            chain = {}
            for inst in opts:
                token = str(inst["instrument_token"])
                if token not in quotes: continue
                q = quotes[token]
                strike = inst["strike"]
                typ = inst["instrument_type"]
                if strike not in chain:
                    chain[strike] = {"C": {}, "P": {}}
                prev = prev_oi.get(strike, {"C": 0, "P": 0})
                base = {
                    "LTP": q.get("last_price", 0),
                    "OI": q.get("oi", 0),
                    "Chg": q.get("oi", 0) - prev["C" if typ=="CE" else "P"],
                    "Vol": q.get("volume", 0)
                }
                chain[strike]["C" if typ=="CE" else "P"] = base

            # Build rows
            rows = [["Call LTP","Call OI","Call Chg","Call Vol","Strike","Expiry","Put LTP","Put OI","Put Chg","Put Vol","PCR","Net Chg"]]
            for strike in sorted(chain):
                c = chain[strike]["C"]
                p = chain[strike]["P"]
                call_oi = c.get("OI", 0)
                put_oi = p.get("OI", 0)
                pcr = round(put_oi/call_oi, 2) if call_oi else 0
                net = (c.get("Chg",0) or 0) - (p.get("Chg",0) or 0)
                rows.append([
                    c.get("LTP",""), call_oi, c.get("Chg",""), c.get("Vol",""),
                    strike, expiry,
                    p.get("LTP",""), put_oi, p.get("Chg",""), p.get("Vol",""),
                    pcr, net
                ])

            ws.clear()
            ws.update("A1", rows)
            print(f"{name} {expiry} → {len(rows)-1} strikes updated")

        except Exception as e:
            print(f"Error {name} {expiry}: {e}")

print("\nAll indices updated successfully!")
